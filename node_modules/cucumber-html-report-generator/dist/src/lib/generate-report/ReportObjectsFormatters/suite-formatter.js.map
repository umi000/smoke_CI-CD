{"version":3,"file":"suite-formatter.js","sourceRoot":"","sources":["../../../../../src/lib/generate-report/ReportObjectsFormatters/suite-formatter.ts"],"names":[],"mappings":"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","sourcesContent":["import * as CommonFunctions from '../../common-functions/common-functions';\nimport * as Messages from '../../helpers/console-messages';\nimport * as Models from '../../models/models';\nimport * as messages from '@cucumber/messages';\nimport { FeatureFormatter } from './feature-formatter';\nimport { v4 as uuidv4 } from 'uuid';\nimport GherkinDocument = messages.GherkinDocument;\nimport IFeature = messages.Feature;\n\nexport class SuiteFactory {\n  private readonly userProperties: Models.ReportGeneration;\n  private readonly suite: Models.ExtendedReport;\n\n  public constructor( userProperies: Models.ReportGeneration ) {\n    this.userProperties = userProperies;\n    this.suite = this.initializeSuite();\n  }\n\n  public async parseJsons ( collectedJsons: Models.Feature[], providedFeatures: GherkinDocument[] | null ): Promise<Models.ExtendedReport> {\n    const features = await Promise.all(\n      collectedJsons.map( jsonFeature => {\n        const gherkinFeature = this.getGherkinFeature( providedFeatures, jsonFeature.name );\n        const feature = new FeatureFormatter( gherkinFeature, jsonFeature ).parseFeature();\n        this.updateSuiteStadistics( feature );\n\n        if ( !feature.elements?.length ) {\n          console.log( Messages.featureRemoved( feature.name ) );\n          return null;\n        }\n        return feature;\n      } )\n    );\n    this.suite.features = features.flatMap( feature => feature ? [ feature ] : [] );\n\n    this.updateSuiteProperties();\n    this.suite.results.overview.result = [ ...new Map( this.suite.results.overview.result.map( item => [ item.status, item ] ) ).values() ];\n    this.suite.results.overview.resultStatusesJoined = this.suite.results.overview.result.map( ( value ) => value.status.toString() ).sort().join( ';' );\n\n    if ( this.suite.features.some( feature => feature.metadata?.length ) ) {\n      this.suite.haveFeaturesMetadata = true;\n    }\n\n    if ( this.userProperties.saveEnrichedJSON ) {\n      await this.saveEnrichedJson();\n    }\n\n    return this.suite;\n  }\n\n  private updateSuiteProperties (): void {\n    this.suite.features = this.suite.features.sort( ( firstFeature, secondFeature ) => ( firstFeature.id! > secondFeature.id! ? 1 : -1 ) );\n    this.addMissingMetadataToFeatures();\n    this.suite.results.overview.durationHHMMSS = CommonFunctions.convertTimeFromNanoSecondsToHHMMSS( this.suite.results.overview.duration );\n    this.suite.metadata = CommonFunctions.isMetadata( this.userProperties.reportMetadata ) ? this.userProperties.reportMetadata : <Models.Metadata[]>[];\n    this.suite.features = this.setUniqueIdForEachFeature( this.suite.features );\n  }\n\n  private async saveEnrichedJson (): Promise<void> {\n    await CommonFunctions.saveJsonFile( this.userProperties.reportPath, 'enriched-output.json', this.suite );\n  }\n\n  private getGherkinFeature ( providedFeatures: GherkinDocument[] | null, jsonFeatureName: string ): IFeature | null | undefined {\n    return providedFeatures?.length ? providedFeatures.filter( document => document.feature?.name === jsonFeatureName )[ 0 ]?.feature : null;\n  }\n\n  private updateSuiteStadistics ( feature: Models.Feature ): void {\n    const overview = feature.results.overview;\n    this.suite.results.overview.duration += overview.duration;\n    this.suite.results.features.passed += overview.result.filter( result => result.status === Models.Status.passed ).length === overview.result.length && overview.result.length ? 1 : 0;\n    this.suite.results.features.failed += overview.result.filter( result => result.status === Models.Status.failed ).length === overview.result.length && overview.result.length ? 1 : 0;\n    this.suite.results.features.pending += overview.result.filter( result => result.status === Models.Status.pending ).length === overview.result.length && overview.result.length ? 1 : 0;\n    this.suite.results.features.skipped += overview.result.filter( result => result.status === Models.Status.skipped ).length === overview.result.length && overview.result.length ? 1 : 0;\n    this.suite.results.features.ambiguous += overview.result.filter( result => result.status === Models.Status.ambiguous ).length === overview.result.length && overview.result.length ? 1 : 0;\n    this.suite.results.features.undefined += overview.result.filter( result => result.status === Models.Status.undefined ).length === overview.result.length && overview.result.length ? 1 : 0;\n    this.suite.results.features.various += Number( [ ... new Set( overview.result ) ].length > 1 );\n    this.suite.results.features.total++;\n\n    this.suite.results.scenarios = CommonFunctions.updateResultsAndPercentages( this.suite.results.scenarios, feature.results.scenarios );\n    this.suite.results.steps = CommonFunctions.updateResultsAndPercentages( this.suite.results.steps, feature.results.steps );\n    this.suite.results.features = <Models.FeatureModuleResults>CommonFunctions.updatePercentages( this.suite.results.features );\n    this.suite.results.overview.result.push( ...feature.results.overview.result );\n  }\n\n  private initializeSuite (): Models.ExtendedReport {\n    const suite = <Models.ExtendedReport>{};\n    suite.results = Models.reportResultsInitializer();\n    suite.metadata = <Models.Metadata[]>[];\n    suite.metadataTitle = this.userProperties.reportMetadataTitle;\n    suite.reportTitle = this.userProperties.reportTitle;\n    suite.haveFeaturesMetadata = false;\n    return suite;\n  }\n\n  private setUniqueIdForEachFeature ( features: Models.Feature[] ): Models.Feature[] {\n    const seen = new Set();\n    const modifiedFeatures = features.map( feature => {\n      if ( seen.size === seen.add( feature.id ).size ) {\n        feature.id += uuidv4();\n      }\n      return feature;\n    } );\n    return modifiedFeatures;\n  }\n\n  private addMissingMetadataToFeatures (): void {\n    const allMetadata: Models.Metadata[] = [];\n    this.suite.features.forEach( feature => {\n      if ( feature.metadata?.length ) {\n        feature.metadata.forEach( metadataElement => {\n          if ( !allMetadata.filter( metadataObject => metadataObject.name === metadataElement.name ).length ) {\n            allMetadata.push( metadataElement );\n          }\n        } );\n      }\n    } );\n    this.suite.results.overview.metadata = allMetadata;\n\n    this.suite.features.forEach( feature => {\n      allMetadata.forEach( metadataElement => {\n        const featureMetadataName = feature.metadata?.filter( featureMetadataElement => featureMetadataElement.name === metadataElement.name );\n        if ( !featureMetadataName?.length ) {\n          feature.metadata!.push( { name: metadataElement.name, value: '' } );\n        }\n      } );\n    } );\n  }\n}\n"]}